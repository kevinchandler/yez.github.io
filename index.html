<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
    <meta name="description" content="A technology blog about a Year of Commits to Open Source projects.">
  

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      A Year of Commits &middot; 
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="http://jakeyesbeck.com/public/css/share.css">
  <link rel="stylesheet" href="http://jakeyesbeck.com/public/css/poole.css">
  <link rel="stylesheet" href="http://jakeyesbeck.com/public/css/syntax.css">
  <link rel="stylesheet" href="http://jakeyesbeck.com/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://jakeyesbeck.com/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="http://jakeyesbeck.com/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      <h2 class='h1'>
        <a href="http://jakeyesbeck.com">
          A Year of Commits
        </a>
      </h2>
      <p class="lead">The rantings of a man looking for inspiration. Embarking on a 365 day adventure of writing code. It might be funny or it might be sad, only time will tell.
</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="http://jakeyesbeck.com">Home</a>
      <a class="sidebar-nav-item" href="/archives">Archives</a>
      <a class="sidebar-nav-item" href="/about">About</a>
      <a class="sidebar-nav-item" href="https://github.com/yez">GitHub</a>
      <a class="sidebar-nav-item" href="https://twitter.com/jakeyesbeck">Twitter</a>
      <a class="sidebar-nav-item" href="/atom.xml">Feed</a>
    </nav>

    <p class='copyright'>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/11/22/how-to-write-futureproof-mocks/">
        How to Write Future-proof Mocks in RSpec 3
      </a>
    </h1>

    

    <span class="post-date">22 Nov 2015</span>
    <span class='share-container'><ul class="share-buttons">
  <li>
    <a href="https://www.facebook.com/sharer/sharer.php?u=http://jakeyesbeck.com/2015/11/22/how-to-write-futureproof-mocks/&t=How to Write Future-proof Mocks in RSpec 3" title="Share on Facebook" target="_blank">
      <img src="http://jakeyesbeck.com/assets/images/facebook.svg">
    </a>
  </li>
  <li>
    <a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Fjakeyesbeck.com&text=How to Write Future-proof Mocks in RSpec 3%20http://jakeyesbeck.com/2015/11/22/how-to-write-futureproof-mocks/&via=jakeyesbeck" target="_blank" title="Tweet">
      <img src="http://jakeyesbeck.com/assets/images/twitter.svg">
    </a>
  </li>
  <li>
    <a href="https://plus.google.com/share?url=http://jakeyesbeck.com/2015/11/22/how-to-write-futureproof-mocks/" target="_blank" title="Share on Google+">
      <img src="http://jakeyesbeck.com/assets/images/google_plus.svg">
    </a>
  </li>

  <li>
    <a href="https://news.ycombinator.com/submitlink?u=http://jakeyesbeck.com/2015/11/22/how-to-write-futureproof-mocks/&t=How to Write Future-proof Mocks in RSpec 3" target="_blank" title="Share on Hacker News">
      <img src="http://jakeyesbeck.com/assets/images/ycomb.svg">
    </a>
  </li>

  <li>
    <a href="https://getpocket.com/save?url=http://jakeyesbeck.com/2015/11/22/how-to-write-futureproof-mocks/&title=How to Write Future-proof Mocks in RSpec 3" target="_blank" title="Add to Pocket">
      <img src="http://jakeyesbeck.com/assets/images/pocket.svg">
    </a>
  </li>
  <li>
    <a href="http://www.reddit.com/submit?url=http://jakeyesbeck.com/2015/11/22/how-to-write-futureproof-mocks/&title=How to Write Future-proof Mocks in RSpec 3" target="_blank" title="Submit to Reddit">
      <img src="http://jakeyesbeck.com/assets/images/reddit.svg">
    </a>
  </li>
</ul>
</span>

    <p>Tests are an important component in most software applications. Whether tests drive the development, or are bootstrapped on after the fact, tests need to be reliable for future development to progress. An application&#39;s complexity rises with time. During and after this increase, a rock solid test suite is crucial.</p>

<h2>Let the Dogs Out</h2>

<p>Given an application that deals with <code>Dogs</code>:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Dog</span>
<span class="k">end</span>
</code></pre></div>
<p>Keeping track of grooming statistics about this application&#39;s dogs is the obvious cash cow. But that sounds very tedious and complicated, so we can assume that a <code>GroomingService</code> exists that exposes a single <code>Groomer</code> object:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">GroomingService</span>
  <span class="k">class</span> <span class="nc">Groomer</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">dog</span><span class="p">)</span>
      <span class="vi">@dog</span> <span class="o">=</span> <span class="n">dog</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">groom</span>
      <span class="c1"># Some complex grooming logic</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>This service was included by the <code>groomer</code> gem and will become a core piece of the application. To keep everyone in the project sane and well rested, a robust spec suite is needed.</p>

<h2>Spec It Up</h2>

<p>Using <code>RSpec</code> and the <code>GroomingService</code>, a very basic test can be written to make sure the code works as expected.</p>

<p>Introducing the <code>GroomingService</code> into the <code>Dog</code> class could look like:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Dog</span>
  <span class="k">def</span> <span class="nf">groom</span>
    <span class="no">GroomingService</span><span class="o">::</span><span class="no">Groomer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">groom</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The first test should be to make sure that when the <code>groom</code> method on a <code>Dog</code> is called, it initializes and calls <code>groom</code> out to the <code>GroomService::Groomer</code> object.</p>

<p>When asserting that a certain set of methods is called on a particular object, the built in <a href="https://www.relishapp.com/rspec/rspec-mocks/v/3-4/docs/basics/test-doubles">RSpec double</a> method is very handy.</p>

<p>The <code>double</code> method returns a stand-in object to assert <code>allow</code> and <code>expect</code> messages against. Any method that is called on the test double which is not explicitly <code>allow</code>ed or <code>expect</code>ed results in an error.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Dog</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="n">described_class</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s1">&#39;#groom&#39;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:groomer</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="no">GroomingService</span><span class="o">::</span><span class="no">Groomer</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s1">&#39;initializes and calls groom&#39;</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">GroomingService</span><span class="o">::</span><span class="no">Groomer</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="p">{</span> <span class="n">groomer</span> <span class="p">}</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">groomer</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:groom</span><span class="p">)</span>

      <span class="n">subject</span><span class="o">.</span><span class="n">groom</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>As expected, this test passes beautifully:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$:</span> rspec dog_spec.rb

Dog
  <span class="c">#groom</span>
    calls new with self and <span class="k">then</span> groom

Finished in 0.00773 seconds <span class="o">(</span>files took 0.09367 seconds to load<span class="o">)</span>
<span class="m">1</span> example, <span class="m">0</span> failures
</code></pre></div>
<p>That can be it, right? Pack it up and put the dogs away, whoever let them out will have to do it all again later.</p>

<h2>Think of the Future</h2>

<p>After some time passes, it comes to pass that the <code>GroomingService::Grommer</code> has changed its method signature. Instead of the <code>groom</code> method, it has changed to <code>groom!</code>. Chances are someone thought that either the method had too many side affects or that <code>!</code> are just really awesome looking.</p>

<p>In any case, the included service changes and when the test runs:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$:</span> rspec mock_examples_spec.rb

Dog
  <span class="c">#groom</span>
    calls new with self and <span class="k">then</span> groom

Finished in 0.00735 seconds <span class="o">(</span>files took 0.10532 seconds to load<span class="o">)</span>
<span class="m">1</span> example, <span class="m">0</span> failures
</code></pre></div>
<p><em>It passes</em>? How can that be? The method changed from <code>groom</code> to <code>groom!</code>. The <code>groom</code> method does not even exist on <code>GroomingService::Groomer</code>. It seems that the specs do not care what does or does not exist on the <code>double</code>, they just happily pass.</p>

<p>The answer here is to use <code>instance_double</code>. Like <code>double</code>, <code>instance_double</code> also returns a stand-in object that raises errors if methods not <code>allow</code>ed or <code>expect</code>ed are called on the object.</p>

<p>The key difference is that <code>instance_double</code> checks the underlying object to make sure that it responds to methods before making assertions that they are called.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">Dog</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="n">described_class</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s1">&#39;#groom&#39;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:groomer</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="no">GroomingService</span><span class="o">::</span><span class="no">Groomer</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s1">&#39;initializes and calls groom&#39;</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">GroomingService</span><span class="o">::</span><span class="no">Groomer</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="p">{</span> <span class="n">groomer</span> <span class="p">}</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">groomer</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:groom</span><span class="p">)</span>

      <span class="n">subject</span><span class="o">.</span><span class="n">groom</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Now running this test, we see the failure we should expect:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$:</span> rspec dog_spec.rb

Dog
  <span class="c">#groom</span>
    calls new with self and <span class="k">then</span> groom <span class="o">(</span>FAILED - 1<span class="o">)</span>

Failures:

  1<span class="o">)</span> Dog#groom calls new with self and <span class="k">then</span> groom
     Failure/Error: expect<span class="o">(</span>groomer<span class="o">)</span>.to receive<span class="o">(</span>:groom<span class="o">)</span>
       the GroomingService::Groomer class does not implement the instance method: groom
     <span class="c"># ./mock_examples_spec.rb:44:in `block (3 levels) in &lt;top (required)&gt;&#39;</span>

Finished in 0.0054 seconds <span class="o">(</span>files took 0.08288 seconds to load<span class="o">)</span>
<span class="m">1</span> example, <span class="m">1</span> failure
</code></pre></div>
<p>While no one likes failing specs, I would rather see a failure here than in production.</p>

<p>Since the API that we do not own changed (<code>Groomer</code>), it was a mistake to blindly mock it without asking the underlying object if that method existed. However, with this problem corrected, the code is more robust and development can continue.</p>

<h2>Mocking with Confidence</h2>

<p>Asserting that a method is called on an object is a very common pattern in Ruby tests. Additionally, Ruby does not have the benefit of compiled languages in terms of method invocation validation. We as Rubyists rely on automated testing to make sure that our applications work as expected, can be iterated upon, and handle third party library updates. While it may be attractive to use permissive mocking assertions, they can be dangerous and cause more problems than they are worth.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="http://jakeyesbeck.com/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>

    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62292380-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
