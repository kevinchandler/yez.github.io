<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
    <meta name="description" content="Five Active Record tools you should be using in your every day. These tools make writing queries easy and perfomant.">
  

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Five Active Record Features You Should Be Using &middot; A Year of Commits
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="http://jakeyesbeck.com/public/css/share.css">
  <link rel="stylesheet" href="http://jakeyesbeck.com/public/css/poole.css">
  <link rel="stylesheet" href="http://jakeyesbeck.com/public/css/syntax.css">
  <link rel="stylesheet" href="http://jakeyesbeck.com/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://jakeyesbeck.com/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="http://jakeyesbeck.com/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      <h2 class='h1'>
        <a href="http://jakeyesbeck.com">
          A Year of Commits
        </a>
      </h2>
      <p class="lead">The rantings of a man looking for inspiration. Embarking on a 365 day adventure of writing code. It might be funny or it might be sad, only time will tell.
</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="http://jakeyesbeck.com">Home</a>
      <a class="sidebar-nav-item" href="/archives">Archives</a>
      <a class="sidebar-nav-item" href="/about">About</a>
      <a class="sidebar-nav-item" href="https://github.com/yez">GitHub</a>
      <a class="sidebar-nav-item" href="https://twitter.com/jakeyesbeck">Twitter</a>
      <a class="sidebar-nav-item" href="/atom.xml">Feed</a>
    </nav>

    <p class='copyright'>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Five Active Record Features You Should Be Using</h1>
  <span class="post-date">15 Nov 2015</span>
  
  <span class='share-container'><ul class="share-buttons">
  <li>
    <a href="https://www.facebook.com/sharer/sharer.php?u=http://jakeyesbeck.com/2015/11/15/five-active-record-features-you-should-be-using/&t=Five Active Record Features You Should Be Using" title="Share on Facebook" target="_blank">
      <img src="http://jakeyesbeck.com/assets/images/facebook.svg">
    </a>
  </li>
  <li>
    <a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Fjakeyesbeck.com&text=Five Active Record Features You Should Be Using%20http://jakeyesbeck.com/2015/11/15/five-active-record-features-you-should-be-using/&via=jakeyesbeck" target="_blank" title="Tweet">
      <img src="http://jakeyesbeck.com/assets/images/twitter.svg">
    </a>
  </li>
  <li>
    <a href="https://plus.google.com/share?url=http://jakeyesbeck.com/2015/11/15/five-active-record-features-you-should-be-using/" target="_blank" title="Share on Google+">
      <img src="http://jakeyesbeck.com/assets/images/google_plus.svg">
    </a>
  </li>

  <li>
    <a href="https://news.ycombinator.com/submitlink?u=http://jakeyesbeck.com/2015/11/15/five-active-record-features-you-should-be-using/&t=Five Active Record Features You Should Be Using" target="_blank" title="Share on Hacker News">
      <img src="http://jakeyesbeck.com/assets/images/ycomb.svg">
    </a>
  </li>

  <li>
    <a href="https://getpocket.com/save?url=http://jakeyesbeck.com/2015/11/15/five-active-record-features-you-should-be-using/&title=Five Active Record Features You Should Be Using" target="_blank" title="Add to Pocket">
      <img src="http://jakeyesbeck.com/assets/images/pocket.svg">
    </a>
  </li>
  <li>
    <a href="http://www.reddit.com/submit?url=http://jakeyesbeck.com/2015/11/15/five-active-record-features-you-should-be-using/&title=Five Active Record Features You Should Be Using" target="_blank" title="Submit to Reddit">
      <img src="http://jakeyesbeck.com/assets/images/reddit.svg">
    </a>
  </li>
</ul>
</span>
  <p>Active Record is responsible for communicating with the persistence layer by default in Ruby on Rails applications. Using Active Record effectively and efficiently can greatly improve an application&#39;s code.</p>

<p>In Ruby on Rails 4.0, some material changes have been made to Active Record. Understanding these changes, and how they are best utilized is important for any Rails developer.</p>

<p>To help explain these concepts, we can assume a Ruby on Rails application <em>&quot;booksandreviews.com&quot;</em> exists with three models:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
  <span class="n">has_many</span> <span class="ss">:reviews</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Review</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>
<span class="k">end</span>
</code></pre></div>
<p>The smart people over at <em>&quot;booksandreviews.com&quot;</em> need to know what the state of their data to build metrics and make sales. Metrics need data and Active Record will be used to fetch that data.</p>

<h2>1. Nested Queries</h2>

<p>When doing database queries, the fewer the better. Since Active Record is responsible of crafting these queries, it is important to make sure it has all the help it needs. For simple queries this is rarely an issue, but more complex requirements can lead to sub-optimal results.</p>

<p>One day, Tim from sales comes rampaging through the office convinced that there <strong>must</strong> be a bug in the system. A recent sale for <em>&quot;booksandreviews.com&quot;</em> did not go well and he wants answers. Tim wants an analysis run. He wants all reviews published today, which are for books published in 2015.</p>

<p>Without too much thought, this approach seems reasonable:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">book_ids</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">publish_year</span><span class="p">:</span> <span class="s1">&#39;2015&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="c1"># =&gt; SELECT &quot;books&quot;.* FROM &quot;books&quot; WHERE (publish_year = &#39;2015&#39;)</span>

<span class="n">reviews</span> <span class="o">=</span> <span class="no">Review</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">publish_date</span><span class="p">:</span> <span class="s1">&#39;2015-11-15&#39;</span><span class="p">,</span>
                       <span class="ss">book_ids</span><span class="p">:</span> <span class="n">book_ids</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1"># =&gt; SELECT &quot;reviews&quot;.* FROM &quot;reviews&quot; WHERE &quot;reviews&quot;.&quot;publish_date&quot; = &#39;2015-11-15&#39; AND &quot;reviews&quot;.&quot;book_ids&quot; IN (1, 2, 3)</span>
</code></pre></div>
<p>This will load the desired books, extract their <code>id</code>&#39;s, and pass that result to the <code>Review</code> query. Not only does this generate two queries, it also wastes memory by creating an array of <code>Book</code> objects to <code>map</code> over and then another array of <code>book_ids</code>. With a large enough list of books, this could cause some serious problems.</p>

<p>Active Record&#39;s <code>where</code> method returns an instance of <code>ActiveRecord::Relation</code>. These relations can be passed to other methods to aid in query construction. With the same request, we can save the <code>map</code> and array creation:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">books</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">publish_year</span><span class="p">:</span> <span class="s1">&#39;2015&#39;</span><span class="p">)</span>
<span class="c1"># =&gt; ActiveRecord::Relation</span>

<span class="n">reviews</span> <span class="o">=</span> <span class="no">Review</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">publish_date</span><span class="p">:</span> <span class="s1">&#39;2015-11-15&#39;</span><span class="p">,</span> <span class="ss">book</span><span class="p">:</span> <span class="n">books</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1"># SELECT &quot;reviews&quot;.* FROM &quot;reviews&quot; WHERE &quot;reviews&quot;.&quot;publish_date&quot; = &#39;2015-11-15&#39; AND &quot;reviews&quot;.&quot;book_id&quot; IN (SELECT &quot;books&quot;.&quot;id&quot; FROM &quot;books&quot; WHERE &quot;books&quot;.&quot;publish_year&quot; = &#39;2015&#39;)</span>
</code></pre></div>
<p>This still executes two <code>SELECT</code> statements but it nests them to let the database take care of memory allocation and optimization. The <code>book_ids</code> array is replaced with the <code>books</code> relation and is passed to the <code>Review</code> query.</p>

<p><strong>Note: This can reduced to a single query with <code>.joins</code>, but for now we can assume that a nested query is desired.</strong></p>

<h2>2. DRY Scopes</h2>

<p>Still fuming, Tim demands more information. Now he wants to know the list of all <code>Books</code> published in 2015 which have at least one approved <code>Review</code>. Since <code>Reviews</code> are subjective, they need to be approved in order to maintain the quality that <em>&quot;booksandreviews.com&quot;</em> is known for.</p>

<p>Luckily, a scope has been written on the <code>Review</code> class to accomplish this.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Review</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:book</span>

  <span class="n">scope</span> <span class="ss">:approved</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">approved</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>However, it is <code>Books</code> that we need to return, not <code>Reviews</code>. Repeating the scope definition, a join query can be used for this analysis:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">books</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">publish_year</span><span class="p">:</span> <span class="s1">&#39;2015&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:reviews</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;reviews.approved = ?&#39;</span><span class="p">,</span> <span class="kp">true</span> <span class="p">)</span>
            <span class="o">.</span><span class="n">to_a</span>
<span class="c1"># =&gt; SELECT &quot;books&quot;.* FROM &quot;books&quot; INNER JOIN &quot;reviews&quot; ON &quot;reviews&quot;.&quot;book_id&quot; = &quot;books&quot;.&quot;id&quot; WHERE &quot;books&quot;.&quot;publish_year&quot; = &quot;2015&quot; AND &quot;reviews&quot;.&quot;approved&quot; = &quot;t&quot;</span>
</code></pre></div>
<p><code>Books</code> are returned at the cost of duplicating the <code>approved</code> scope. That means that the scope in <code>Review</code> changes, this code will not benefit from that change.</p>

<p>The <strong>D</strong>on&#39;t <strong>R</strong>epeat <strong>Y</strong>ourself (DRY) principle was created for this exact reason. When identical code is not shared and instead repeated, changes to one version can have dangerous consequences on the other.</p>

<p>The good news is that Active Record provides precisely the medicine for this ailment: <code>.merge</code>.</p>

<p>With <code>.merge</code>, an existing scope can be used in another Active Record query.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">books</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">publish_year</span><span class="p">:</span> <span class="s1">&#39;2015&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:reviews</span><span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="no">Review</span><span class="o">.</span><span class="n">approved</span><span class="p">)</span>
            <span class="o">.</span><span class="n">to_a</span>
<span class="c1"># =&gt; SELECT &quot;books&quot;.* FROM &quot;books&quot; INNER JOIN &quot;reviews&quot; ON &quot;reviews&quot;.&quot;book_id&quot; = &quot;books&quot;.&quot;id&quot; WHERE &quot;books&quot;.&quot;publish_year&quot; = &quot;2015&quot; AND &quot;reviews&quot;.&quot;approved&quot; = &quot;t&quot;</span>
</code></pre></div>
<p>Great! Now the results are the exact same and the code is DRY.</p>

<h2>3. <code>where.not</code></h2>

<p>Typical insatiable Tim is back with yet another request to add to the brand new &quot;totally not vanity metrics dashboard&quot;. Now, he wants to know all the books <strong>not</strong> published in 2012.</p>

<p>Without even asking why such a silly request is necessary, some more code can be cranked out:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">books</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s1">&#39;publish_year != 2012&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1"># =&gt; SELECT &quot;books&quot;.* FROM &quot;books&quot; WHERE (publish_year != &#39;2012&#39;)</span>
</code></pre></div>
<p>Like before, this code works but could be better. There is some raw SQL in there that the next developer might not understand well enough to manipulate. Whatever the reason, it is best to rely on abstraction instead of explicit SQL.</p>

<p>To help solve this dilemma, the <code>.not</code> modifier has been introduced in Active Record 4.0.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">books</span> <span class="o">=</span> <span class="no">Book</span><span class="o">.</span><span class="n">where</span><span class="o">.</span><span class="n">not</span><span class="p">(</span><span class="ss">publish_year</span><span class="p">:</span> <span class="mi">2012</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
<span class="c1"># =&gt; SELECT &quot;books&quot;.* FROM &quot;books&quot; WHERE (publish_year != &#39;2012&#39;)</span>
</code></pre></div>
<p>The result is the same but look how much nicer that is. Not only is the raw SQL gone, the code is more positive too.</p>

<h2>4. <code>first</code> and <code>take</code></h2>

<p>Since <em>&quot;booksandreviews.com&quot;</em> has been around since 2012, chances are it upgraded from Ruby on Rails 3.0 to 4.0. One notable change from Active Record 3 to 4 is the behaviour of <code>.first</code>.</p>

<p>In Ruby on Rails 4.0+, the <code>.first</code> method returns the first row after the table has been ordered by its <code>id</code>.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Author</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">first_name</span><span class="p">:</span> <span class="s1">&#39;Bill&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;first_name&quot; = &quot;Bill&quot; ORDER BY &quot;authors&quot;.&quot;id&quot; ASC LIMIT 1</span>
</code></pre></div>
<p>This will work fine for every table that has an <code>id</code> column. However, if a table does not need an <code>id</code> column, this method causes a problem.</p>

<p>Despite each <code>Author</code> having an id, complex joins might cause an issue with an implicit <code>ORDER BY</code> on queries.</p>

<p>To alleviate that problem, the <code>take</code> method can be substituted for <code>first</code>:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Author</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">first_name</span><span class="p">:</span> <span class="s1">&#39;Bill&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">take</span>
<span class="c1"># =&gt; SELECT  &quot;authors&quot;.* FROM &quot;authors&quot; WHERE &quot;authors&quot;.&quot;first_name&quot; = &quot;Bill&quot; LIMIT 1</span>
</code></pre></div>
<p>This behaves in a much more explicit way, returning the same information without a default ordering.</p>

<h2>5. <code>.unscoped</code></h2>

<p>During the development life of &quot;<em>booksandreviews.com&quot;</em>, countless modules have been built and gems included. Amidst this chaos, someone must have typed <code>gem install hairball</code> and horribly altered the <code>Author</code> class. This has led to the new guy Mike&#39;s  complaint that: <em>&quot;Authors are missing data&quot;</em>.</p>

<p>Mike knows that authors have a <code>first_name</code> but for some reason it is not being returned:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">authors</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">last_name</span><span class="p">:</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">authors</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:first_name</span><span class="p">)</span>
<span class="c1"># =&gt; [nil, nil, nil, nil, nil]</span>
</code></pre></div>
<p>What Mike does not know is that one of those hairball gems added a default scope to all Active Record objects that begin with the letter &quot;A&quot;. However impossible this bug is, it exists and it is ruining Mike&#39;s day.</p>

<p>What Mike needs is the <code>.unscoped</code> method. This method removes all existing scopes on an Active Record relation.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">authors</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">unscoped</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">last_name</span><span class="p">:</span> <span class="s1">&#39;Smith&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">authors</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:first_name</span><span class="p">)</span>
<span class="c1"># =&gt; [&#39;Frank&#39;, &#39;Frank&#39;, &#39;Jim&#39;, &#39;Frank&#39;, &#39;Frank&#39;]</span>
</code></pre></div>
<p><em>(Is anyone else concerned that there are four Frank Smith authors?)</em></p>

<p>With the <code>.unscoped</code> method, all harmful default scopes are removed and the Franks are free.</p>

<h2>Queries on Queries</h2>

<p>With these five techniques (and probably a lot more), naiive Active Record queries can stay DRY and intuitive. The exhaustive list of what Active Record can provide can be found <a href="http://guides.rubyonrails.org/active_record_querying.html">at Rails Guides</a>.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/11/08/ruby-delegate-class/">
            Ruby DelegateClass
            <small>08 Nov 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/07/19/just-learn-rails-part-2/">
            Just learn Rails (Part 2)
            <small>19 Jul 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/09/20/rails-http-status-codes/">
            Just learn Rails (Part 3) HTTP status codes
            <small>20 Sep 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62292380-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
